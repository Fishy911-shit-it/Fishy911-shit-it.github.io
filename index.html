<!DOCTYPE html>
<html>
<head>
<title>Ultimate Snake</title>
<style>
body{
  background:#111;
  color:white;
  text-align:center;
  font-family:Arial;
}
canvas{
  display:block;
  margin:auto;
  background:black;
}
button{
  padding:10px;
  margin:10px;
}
</style>
</head>
<body>

<h2>Ultimate Snake</h2>
Score: <span id="score">0</span> | High Score: <span id="highscore">0</span><br>
<button onclick="toggleAI()">Toggle Ultra AI</button>

<canvas id="game" width="500" height="500"></canvas>

<script>
const canvas = document.getElementById("game");
const c = canvas.getContext("2d");

let grid = 20;
let size = 25;
let snake = [{x:12,y:12}];
let dir = {x:1,y:0};
let food = randomFood();
let score = 0;
let highscore = localStorage.getItem("snakeHigh") || 0;
let ai = true;
let speed = 100;
let bonusFoods = [];

/* Toggle AI */
function toggleAI(){ ai = !ai; }

/* Food */
function randomFood(){
  let x,y;
  do{
    x = Math.floor(Math.random()*size);
    y = Math.floor(Math.random()*size);
  } while(snake.some(s=>s.x===x && s.y===y));
  return {x,y};
}

/* Bonus Food */
function spawnBonus(){
  let x = Math.floor(Math.random()*size);
  let y = Math.floor(Math.random()*size);
  if(!snake.some(s=>s.x===x && s.y===y)){
    bonusFoods.push({x,y,timer:50});
  }
}
setInterval(spawnBonus,10000);

/* Safe check */
function safe(x,y){
  if(x<0 || y<0 || x>=size || y>=size) return false;
  return !snake.some(s=>s.x===x && s.y===y);
}

/* BFS Pathfinding */
function findPath(start, goal){
  let queue=[{x:start.x,y:start.y,path:[]}];
  let visited = Array(size).fill(0).map(()=>Array(size).fill(false));
  visited[start.y][start.x]=true;
  while(queue.length>0){
    let node = queue.shift();
    if(node.x===goal.x && node.y===goal.y) return node.path;
    [[1,0],[0,1],[-1,0],[0,-1]].forEach(([dx,dy])=>{
      let nx=node.x+dx;
      let ny=node.y+dy;
      if(nx>=0 && ny>=0 && nx<size && ny<size && !visited[ny][nx] && safe(nx,ny)){
        visited[ny][nx]=true;
        queue.push({x:nx,y:ny,path:[...node.path,{x:dx,y:dy}]});
      }
    });
  }
  return null;
}

/* AI Move */
function aiMove(){
  let path = findPath(snake[0], food);
  if(path && path.length>0) dir = path[0];
  else { // fallback safe move
    [[1,0],[0,1],[-1,0],[0,-1]].some(d=>{
      if(safe(snake[0].x+d[0],snake[0].y+d[1])){
        dir={x:d[0],y:d[1]};
        return true;
      }
    });
  }
}

/* Player control */
document.onkeydown=function(e){
  if(ai) return;
  if(e.key=="ArrowUp") dir={x:0,y:-1};
  if(e.key=="ArrowDown") dir={x:0,y:1};
  if(e.key=="ArrowLeft") dir={x:-1,y:0};
  if(e.key=="ArrowRight") dir={x:1,y:0};
}

/* Update */
function update(){
  if(ai) aiMove();

  let head = {x:snake[0].x+dir.x, y:snake[0].y+dir.y};
  if(!safe(head.x,head.y)) return gameOver();
  snake.unshift(head);

  /* Regular food */
  if(head.x===food.x && head.y===food.y){
    score++;
    food = randomFood();
    speed = Math.max(40, speed-2); // increase speed
  } else snake.pop();

  /* Bonus food */
  bonusFoods.forEach((b,i)=>{
    b.timer--;
    if(head.x===b.x && head.y===b.y){
      score+=5;
      bonusFoods.splice(i,1);
      speed = Math.max(30, speed-5);
    }
    else if(b.timer<=0) bonusFoods.splice(i,1);
  });

  document.getElementById("score").textContent = score;
  if(score>highscore){
    highscore=score;
    localStorage.setItem("snakeHigh",highscore);
    document.getElementById("highscore").textContent = highscore;
  }
}

/* Draw */
function draw(){
  c.fillStyle="black";
  c.fillRect(0,0,500,500);

  /* Food */
  c.fillStyle="red";
  c.fillRect(food.x*grid, food.y*grid, grid, grid);

  /* Bonus food */
  c.fillStyle="gold";
  bonusFoods.forEach(b=>c.fillRect(b.x*grid, b.y*grid, grid, grid));

  /* Snake */
  c.fillStyle="lime";
  snake.forEach((s,i)=>{
    c.fillStyle=`hsl(${(i*15)%360},100%,50%)`;
    c.fillRect(s.x*grid, s.y*grid, grid, grid);
  });
}

/* Game over */
function gameOver(){
  alert("Game Over! Score: "+score);
  location.reload();
}

/* Loop */
function loop(){
  update();
  draw();
  setTimeout(loop, speed);
}
loop();

</script>
</body>
</html>
